networks:
  zabbix-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16

volumes:
  postgres-data:
    external: true
    name: zabbix-postgres-data
  grafana-data:
    external: true
    name: zabbix-grafana-data
  loki-data:
    external: true
    name: zabbix-loki-data
  zabbix-alertscripts:
  zabbix-externalscripts:
  zabbix-modules:
  zabbix-enc:
  zabbix-ssh-keys:
  zabbix-ssl-certs:
  zabbix-ssl-keys:
  zabbix-ssl-ssl-ca:
  zabbix-snmptraps:
  zabbix-mibs:

services:

  # PostgreSQL Database
  postgres:
    image: postgres:15.15-alpine
    container_name: zabbix-postgres
    hostname: zabbix-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-zabbix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-zabbix}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    shm_size: 256m
    restart: unless-stopped
    networks:
      - zabbix-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-zabbix} -d ${POSTGRES_DB:-zabbix}"]
      interval: 15s
      timeout: 10s
      retries: 12
      start_period: 45s
    labels:
      - 'wud.tag.include=^15\.\d+$'
      - 'wud.watch=true'

  # SNMP Trap Daemon - Dôležité pre UPS a sieťové prvky
  zabbix-snmptraps:
    image: zabbix/zabbix-snmptraps:ubuntu-7.4-latest
    container_name: zabbix-snmptraps
    hostname: zabbix-snmptraps
    ports:
      - "1162:1162/udp"
    volumes:
      - zabbix-snmptraps:/var/lib/zabbix/snmptraps:rw
      - zabbix-mibs:/usr/share/snmp/mibs:ro
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    networks:
      - zabbix-net
    labels:
      - 'wud.tag.include=^ubuntu-7\.\d+\.\d+$'
      - 'wud.watch=true'

  # Zabbix Server - Váš Custom Build s Chromom
  zabbix-server:
    build:
      context: ./zabbix-server
      dockerfile: Dockerfile.ubuntu-chrome
    container_name: zabbix-server
    hostname: zabbix-server
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      DB_SERVER_HOST: postgres
      DB_SERVER_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-zabbix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-zabbix}
      ZBX_ENABLE_SNMP_TRAPS: "true"
      # Posilnené pollery pre SNMP a Ping (UPS, Tlačiarne, Fortinet)
      ZBX_STARTPOLLERS: ${ZBX_STARTPOLLERS:-20}
      ZBX_STARTTRAPPERS: ${ZBX_STARTTRAPPERS:-15}
      ZBX_STARTPINGERS: ${ZBX_STARTPINGERS:-10}
      ZBX_CACHESIZE: ${ZBX_CACHESIZE:-256M}
      ZBX_VALUECACHESIZE: ${ZBX_VALUECACHESIZE:-128M}
      ZBX_TIMEOUT: ${ZBX_TIMEOUT:-30}
      ZBX_TRENDCACHESIZE: 128M
      STARTREPORTWRITERS: "1"
      WEBSERVICEURL: "http://zabbix-web-service:10053/report"
      TZ: ${TZ:-Europe/Bratislava}
    ports:
      - "10051:10051"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - zabbix-alertscripts:/usr/lib/zabbix/alertscripts:ro
      - zabbix-externalscripts:/usr/lib/zabbix/externalscripts:ro
      - zabbix-snmptraps:/var/lib/zabbix/snmptraps:ro
      - zabbix-mibs:/usr/share/snmp/mibs:ro
    depends_on:
      postgres:
        condition: service_healthy
      zabbix-snmptraps:
        condition: service_started
    restart: unless-stopped
    networks:
      - zabbix-net
    healthcheck:
      test: ["CMD-SHELL", "zabbix_server -R config_cache_reload || exit 1"]
    labels:
      - 'wud.tag.include=^ubuntu-7\.\d+\.\d+$'
      - 'wud.watch=true'

  # Zabbix Web Interface - OPRAVA ERROR 500
  zabbix-frontend:
    image: zabbix/zabbix-web-nginx-pgsql:ubuntu-7.4-latest
    container_name: zabbix-frontend
    hostname: zabbix-frontend
    environment:
      DB_SERVER_HOST: postgres
      POSTGRES_USER: ${POSTGRES_USER:-zabbix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      ZBX_SERVER_HOST: zabbix-server
      PHP_TZ: ${PHP_TZ:-Europe/Bratislava}
      # Navýšená pamäť pre PHP, aby Latest Data nezlyhávalo
      ZBX_MEMORYLIMIT: 1024M
      ZBX_MAXEXECUTIONTIME: 600
      ZBX_POSTMAXSIZE: 32M
    ports:
      - "8080:8080"
    depends_on:
      zabbix-server:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - zabbix-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]

  # Zabbix Web Service (pre PDF reporty)
  zabbix-web-service:
    image: zabbix/zabbix-web-service:ubuntu-7.4-latest
    container_name: zabbix-web-service
    environment:
      ZBX_ALLOWEDIP: 172.18.0.0/16
    restart: unless-stopped
    networks:
      - zabbix-net

  # Grafana - Priamo napojená na Zabbix API
  grafana:
    image: grafana/grafana:11.6.10
    container_name: grafana
    environment:
      GF_INSTALL_PLUGINS: alexanderzobnin-zabbix-app
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      TZ: ${TZ:-Europe/Bratislava}
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    restart: unless-stopped
    networks:
      - zabbix-net

  # Loki (Logy zo sieťových prvkov a Linuxu)
  loki:
    image: grafana/loki:latest
    container_name: loki
    volumes:
      - ./loki:/etc/loki
      - loki-data:/loki
    command: -config.file=/etc/loki/loki-config.yml
    restart: unless-stopped
    networks:
      - zabbix-net
