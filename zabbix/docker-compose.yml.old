services:
  postgres:
    image: postgres:15-alpine
    container_name: zabbix-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-zabbix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zabbixpass}
      POSTGRES_DB: ${POSTGRES_DB:-zabbix}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "max_connections=400"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "log_statement=none"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-zabbix} -d ${POSTGRES_DB:-zabbix}"]
      interval: 15s
      timeout: 10s
      retries: 12
      start_period: 45s
    networks:
      - zabbix-net

  zabbix-server:
    image: zabbix/zabbix-server-pgsql:7.4.5-alpine
    container_name: zabbix-server
    environment:
      DB_SERVER_HOST: postgres
      POSTGRES_USER: ${POSTGRES_USER:-zabbix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zabbixpass}
      POSTGRES_DB: ${POSTGRES_DB:-zabbix}
      TZ: ${TZ:-Europe/Bratislava}
      ZBX_STARTPOLLERS: 20
      ZBX_STARTPOLLERSUNREACHABLE: 10
      ZBX_STARTTRAPPERS: 15
      ZBX_STARTPINGERS: 5
      ZBX_STARTDISCOVERERS: 3
      ZBX_STARTHTTPPOLLERS: 1
      ZBX_STARTTIMERS: 2
      ZBX_HISTORYCACHESIZE: 64M
      ZBX_TRENDCACHESIZE: 32M
      ZBX_VALUECACHESIZE: 16M
      ZBX_STARTUPTIMEOUT: 300
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "10051:10051"
    restart: unless-stopped
    networks:
      - zabbix-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - zabbix-alertscripts:/usr/lib/zabbix/alertscripts
      - zabbix-externalscripts:/usr/lib/zabbix/externalscripts
      - zabbix-modules:/var/lib/zabbix/modules
      - zabbix-enc:/var/lib/zabbix/enc
      - zabbix-ssh-keys:/var/lib/zabbix/ssh_keys
      - zabbix-ssl-certs:/var/lib/zabbix/ssl/certs
      - zabbix-ssl-keys:/var/lib/zabbix/ssl/keys
      - zabbix-ssl-ssl-ca:/var/lib/zabbix/ssl/ssl_ca
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pgrep zabbix_server >/dev/null && nc -z localhost 10051 || exit 1"
        ]
      interval: 30s
      timeout: 25s
      retries: 6
      start_period: 120s

  zabbix-frontend:
    image: zabbix/zabbix-web-nginx-pgsql:7.4.5-alpine
    container_name: zabbix-frontend
    environment:
      DB_SERVER_HOST: postgres
      POSTGRES_USER: ${POSTGRES_USER:-zabbix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zabbixpass}
      POSTGRES_DB: ${POSTGRES_DB:-zabbix}
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
      PHP_TZ: ${PHP_TZ:-Europe/Bratislava}
      PHP_FPM_SENDMAIL_PATH: /bin/true
    depends_on:
      postgres:
        condition: service_healthy
      zabbix-server:
        condition: service_healthy
    ports:
      - "8080:8080"
    restart: unless-stopped
    networks:
      - zabbix-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 90s

  zabbix-agent:
    image: zabbix/zabbix-agent2:7.4.5-alpine
    container_name: zabbix-agent
    user: root
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    environment:
      ZBX_HOSTNAME: ${ZBX_HOSTNAME:-zabbix-docker}
      ZBX_HOSTMETADATA: ${ZBX_HOSTMETADATA:-docker}
      TZ: ${TZ:-Europe/Bratislava}
    # ODSTRÁŇTE všetky ZBX_SERVER_* premenné - použijeme config file
    depends_on:
      zabbix-server:
        condition: service_healthy
    ports:
      - "10050:10050"
    restart: unless-stopped
    networks:
      - zabbix-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - ./zabbix-agent/zabbix_agent2.conf:/etc/zabbix/zabbix_agent2.conf:ro
    command:
      - /usr/sbin/zabbix_agent2
      - -f
      - -c
      - /etc/zabbix/zabbix_agent2.conf
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pgrep zabbix_agent2 >/dev/null && nc -z localhost 10050 || exit 1"
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin123}
      GF_SERVER_DOMAIN: localhost
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_INSTALL_PLUGINS: alexanderzobnin-zabbix-app
      TZ: ${TZ:-Europe/Bratislava}
      GF_SECURITY_SECRET_KEY: ${GF_SECURITY_SECRET_KEY:-your_secure_secret_key_here}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_USERS_ALLOW_ORG_CREATE: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    depends_on:
      zabbix-server:
        condition: service_healthy
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/provisioning/dashboards/dashboards:/var/lib/grafana/dashboards:ro
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    networks:
      - zabbix-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 6
      start_period: 60s

networks:
  zabbix-net:
    driver: bridge

volumes:
  postgres-data:
  grafana-data:
  zabbix-alertscripts:
  zabbix-externalscripts:
  zabbix-modules:
  zabbix-enc:
  zabbix-ssh-keys:
  zabbix-ssl-certs:
  zabbix-ssl-keys:
  zabbix-ssl-ssl-ca:
